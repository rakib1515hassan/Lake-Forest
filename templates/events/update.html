{% extends 'layouts/master.html' %}
{% load static %}

{% block title %}
Address PMS | Update Property
{% endblock title %}


{% block styles %}
{% endblock styles %}


{% block content %}
<div class="card mb-3">
    <div class="card-header">
        <div class="row flex-between-end">
            <div class="col-auto align-self-center">
                <h5 class="mb-0" data-anchor="data-anchor">Update Property Information</h5>
            </div>
        </div>
    </div>
    <div class="card-body bg-light">
        <div class="tab-content">
            
            <form class="row g-3 needs-validation" novalidate="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Owner</label>
                    {{ form.user }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Title</label>
                    {{ form.title }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Size 
                        <span>(Square Feet - ft²)</span>
                    </label>
                    {{ form.size }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Price 
                        ( <span class="fw-bold fs-3"> ৳</span> )
                    </label>
                    {{ form.price }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Bed</label>
                    {{ form.bed }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Bath</label>
                    {{ form.bath }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->
                <h5>Property Video</h5>
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Video</label>
                    {{ form.video }}
                </div>

                <div class="col-md-6">
                    <!-- <div class="player rounded-3" data-plyr-provider="youtube" data-plyr-embed-id="bTqVqk7FSmY"> -->
                    {% if property.video %}
                        <video width="600" controls style="border-radius: 6px;">
                            <source src="{{ property.video.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% else %}
                        <p>No video available for this property.</p>
                    {% endif %}
                    <!-- </div> -->
                </div>
                

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->
                <h5>Property Floor Plans</h5>
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Floor Plans</label>
                    {{ form.floor_plans }}
                </div>
                <div class="col-md-6">
                    {% if property.floor_plans %}
                    <a href="{{property.floor_plans.url}}" data-gallery="gallery-2">
                        <img class="img-fluid rounded" src="{{property.floor_plans.url}}" alt="" width="300" />
                    </a>
                    {% endif %}
                </div>
                

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <h5>Property Features</h5>
                <!--  -->
                <div class="col-md-6 mb-3">
                    <label class="form-label" for="validationCustom01">Features</label>
                    {{ form.property_features }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <h5>Property Purpose</h5>
                <!--  -->
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Purpose</label>
                    {{ form.property_purpose }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <h5>Property Type</h5>
                <!--  -->
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Type</label>
                    {{ form.property_type }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="sub-type">Sub-Type</label>
                    <select class="form-select" id="id_sub_type" size="1" style="height: 42px;"
                            name="sub_type" data-options='{"removeItemButton":true,"placeholder":true}'>
                        <option disabled>Select sub type</option>
                        {% for sub_type in sub_types %}
                            <option value="{{ sub_type.id }}" 
                                {% if sub_type.id == property.property_sub_type.id %}selected{% endif %}>
                                {{ sub_type.sub_type }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->
                <div class="d-block">
                    <h4 class="">Property Address:</h4>
                    <div class="col-md-6">
                        <label class="form-label" for="validationCustom01">City</label>
                        <select class="form-select js-choice" id="organizerSingle" size="1" name="propery_address_city" data-options='{"removeItemButton":true,"placeholder":true}'>
                            {% for choice_key, choice_value in property.propertyaddress.BangladeshDistrict.choices %}
                                <option value="{{ choice_key }}"
                                    {% if choice_key == property_address.city %}selected{% endif %}>
                                    {{ choice_value }}
                                </option>
                            {% endfor %}
                            
                        </select>
                    </div>
                    
                    
                    <div class="col-md-6">
                        <label class="form-label" for="validationCustom01">Home Address</label>
                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="3" name="propery_address_location">{{ property_address.location }}</textarea>
                    </div>
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->
                <div class="d-block">
                    <h4 class="">Property Descriptsion:</h4>
                    <div class="col-md-12">
                        {{ form.description }}
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">Property Status</label>
                    {{ form.property_status }}
                </div>

                <div class="col-12 " style="display: flex; justify-content: center;">
                    <button class="btn btn-warning me-1 mb-1" style="padding: 5px 100px;" type="submit">Update</button>
                </div>
            </form>
            

            <!--  -->
            <div class="border-dashed-bottom my-2 mt-5"></div>
            <!--  -->
            <h5>Property Image</h5>
            <div class="col-md-6">
                <button class="btn btn-primary me-1 mb-1" type="button" data-bs-toggle="modal" data-bs-target="#error-modal">
                    <span class="fas fa-plus me-1" data-fa-transform="shrink-3"></span>
                    Add More Image
                </button>
            </div>
            <div class="row mx-n1 mt-5">
                {% for pro_img in pro_imgs %}
                    <div class="col-6 p-1">
                        {% if pro_img.image %}
                        <div class="position-relative">
                            <a class="post1" href="{{pro_img.image.url}}" data-gallery="gallery-1">
                                <img class="img-fluid rounded w-80" src="{{pro_img.image.url}}" alt=""/>
                            </a>
                            <form method="post" class="delete-form">
                                {% csrf_token %}
                                <input type="hidden" name="img_id" value="{{pro_img.id}}">
                                <!-- <button class="btn position-absolute top-0 end-0 m-2 property-img-delete-btn" type="submit">
                                    <i class="fa-solid fa-xmark fa-2xl" style="color: #e42121;"></i>
                                    <i class="fa-solid fa-delete-left fa-2xl" style="color: #d41c1c;"></i>
                                </button> -->
                                <button class="btn-close btn-close-white position-absolute top-0 end-0 m-2 property-img-delete-btn" type="submit" aria-label="Close"></button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div> 

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="error-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 500px">
      <div class="modal-content position-relative">
        <div class="position-absolute top-0 end-0 mt-2 me-2 z-index-1">
          <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div class="rounded-top-lg py-3 ps-4 pe-6 bg-light">
            <h4 class="mb-1" id="modalExampleDemoLabel">Add More Image </h4>
          </div>
          <div class="p-4 pb-0">
            <form action="{% url 'property:property-img-create' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
              <div class="mb-3">
                <label class="col-form-label" for="recipient-name">Recipient:</label>
                <input class="form-control" id="recipient-name" type="file" name="pro_img" />
              </div>
              <input type="hidden" name="property_id" value="{{property.id}}">
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" type="submit">Add </button>
              </div>
            </form>
          </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>

$(document).ready(function () {
    var propertyTypeSelect = $('#id_property_type');
    var subTypeSelect = $('#id_sub_type');

    propertyTypeSelect.on('change', function () {
        var selectedValue = $(this).val();
        console.log('Selected Property Type PK:', selectedValue);

        // Make an AJAX GET request to the API with the selected PK
        $.ajax({
            type: 'GET',
            url : `http://${window.location.host}/apis/property/property-subtypes/${selectedValue}/`,
            dataType: 'json',
            success: function (data) {
                subTypeSelect.empty();

                subTypeSelect.append($('<option>', {
                    value: '',
                    text: '------------------',
                    disabled: true,
                    selected: true, // You can also add this to make it the default selected option
                }));

                if (data && data.length > 0) {
                    data.forEach(function (item) {
                        console.log("Item ID = %s , Item Name = %s", item.id, item.sub_type);
                        subTypeSelect.append($('<option>', {
                            value: item.id,
                            text: item.sub_type
                        }));
                    });
                } else {
                    // Handle the case where no data is received
                    subTypeSelect.append($('<option>', {
                        value: '',
                        text: 'No sub-types available'
                    }));
                }
            },
            error: function (error) {
                console.error('Error fetching data:', error);
            }
        });
    });
});
     
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteForms = document.querySelectorAll('.delete-form');

        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {
                event.preventDefault();  // Prevent the default form submission

                const imgId = this.querySelector('[name="img_id"]').value;

                Swal.fire({
                    title: "Are you sure?",
                    text: "You want to delete this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Perform Axios request to delete view
                        deleteImage(imgId);
                    }
                });
            });
        });

        function deleteImage(imgId) {
            const csrfToken = document.head.querySelector('meta[name="csrf-token"]').content;
            axios.defaults.headers.common['X-CSRFToken'] = csrfToken;

            const url = `/admin/property/property-img-delete/${imgId}/`;

            axios.delete(url)
                .then(response => {
                    if (response.data.success) {
                        return Swal.fire({
                            title: "Deleted!",
                            text: "Your image has been deleted.",
                            icon: "success"
                        });
                    } else {
                        return Swal.fire({
                            title: "Error",
                            text: "Failed to delete the file.",
                            icon: "error"
                        });
                    }
                })
                .then((result) => {
                    if (result.isConfirmed) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });

        }
    });
</script>



{% endblock content %}